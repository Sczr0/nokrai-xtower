---
import "../styles/global.css";

let message = "";
let isError = false;
let stats = { unused: 0, used: 0, reserved: 0, total: 0 };

let recentReservations = [];

try {
  const DB = Astro.locals.runtime?.env?.DB;
  if (DB) {
      // Fetch stats
      const result = await DB.prepare(`
        SELECT 
          SUM(CASE WHEN status = 'unused' THEN 1 ELSE 0 END) as unused,
          SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) as used,
          SUM(CASE WHEN status = 'reserved' THEN 1 ELSE 0 END) as reserved,
          COUNT(*) as total
        FROM invite_codes
      `).first();
      
      stats.unused = result?.unused || 0;
      stats.used = result?.used || 0;
      stats.reserved = result?.reserved || 0;
      stats.total = result?.total || 0;

      // Fetch recent reservations for debugging
      const reservations = await DB.prepare("SELECT code, trade_no, updated_at FROM invite_codes WHERE status = 'reserved' ORDER BY updated_at DESC LIMIT 5").all();
      recentReservations = reservations.results || [];
  }
} catch (e) {
  console.error("Failed to fetch stats:", e);
}

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const password = (formData.get("password") || "").trim();
    const runtimePassword = Astro.locals.runtime?.env?.ADMIN_PASSWORD;
    const buildPassword = import.meta.env.ADMIN_PASSWORD;
    const adminPassword = (runtimePassword != null ? String(runtimePassword) : (buildPassword || "admin")).trim();
    const action = formData.get("action") || "import";
    
    console.log(`[Admin] Auth check: Input length ${password.length}, Env length ${adminPassword.length}`);

    if (password !== adminPassword) {
      throw new Error("密码错误");
    }

    const DB = Astro.locals.runtime?.env?.DB;
    if (!DB) {
        throw new Error("数据库未连接 (D1 Binding Missing)");
    }

    if (action === "cleanup") {
        const { meta } = await DB.prepare("DELETE FROM invite_codes WHERE status = 'used'").run();
        message = `已清理 ${meta.changes} 个已使用的邀请码`;
    } else if (action === "reset_reserved") {
        const { meta } = await DB.prepare("UPDATE invite_codes SET status = 'unused', trade_no = NULL WHERE status = 'reserved'").run();
        message = `已释放 ${meta.changes} 个被锁定的邀请码 (重置为未使用)`;
    } else if (action === "delete_reserved") {
        const { meta } = await DB.prepare("DELETE FROM invite_codes WHERE status = 'reserved'").run();
        message = `已删除 ${meta.changes} 个被锁定的邀请码`;
    } else {
        const codesText = formData.get("codes");
        if (!codesText) {
          throw new Error("请输入邀请码");
        }

        const codes = codesText.toString().split("\n").map(c => c.trim()).filter(c => c);
        
        if (codes.length === 0) {
          throw new Error("没有有效的邀请码");
        }

        const stmt = DB.prepare("INSERT OR IGNORE INTO invite_codes (code) VALUES (?)");
        
        // Batch insert
        const batch = codes.map(code => stmt.bind(code));
        const results = await DB.batch(batch);
        
        const successCount = results.filter(r => r.success).length;
        message = `成功导入 ${successCount} 个邀请码`;
    }
    
  } catch (error) {
    console.error(error);
    message = error.message;
    isError = true;
  }
}
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>邀请码管理 - LinuxDo 商店</title>
  </head>
  <body class="bg-gray-50 text-gray-900 font-sans">
    <div class="mx-auto max-w-2xl px-6 py-12">
      <h1 class="text-3xl font-bold mb-8 text-center">邀请码管理</h1>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div class="text-gray-500 text-sm font-medium mb-1">剩余库存</div>
          <div class="text-3xl font-bold text-blue-600">{stats.unused}</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div class="text-gray-500 text-sm font-medium mb-1">已锁定 (支付中)</div>
          <div class="text-3xl font-bold text-orange-500">{stats.reserved}</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div class="text-gray-500 text-sm font-medium mb-1">已发放</div>
          <div class="text-3xl font-bold text-green-600">{stats.used}</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div class="text-gray-500 text-sm font-medium mb-1">总计</div>
          <div class="text-3xl font-bold text-gray-800">{stats.total}</div>
        </div>
      </div>
      
      <!-- Debug: Recent Reservations -->
      {recentReservations.length > 0 && (
        <div class="mb-8 bg-orange-50 p-6 rounded-2xl border border-orange-100">
           <h2 class="text-lg font-bold text-orange-800 mb-2">最近锁定的订单 (调试用)</h2>
           <div class="overflow-x-auto">
             <table class="w-full text-sm text-left text-gray-500">
               <thead class="text-xs text-gray-700 uppercase bg-orange-100">
                 <tr>
                   <th class="px-4 py-2">订单号 (Trade No)</th>
                   <th class="px-4 py-2">更新时间</th>
                   <th class="px-4 py-2">邀请码 (手动提取)</th>
                 </tr>
               </thead>
               <tbody>
                 {recentReservations.map((row) => (
                   <tr class="bg-white border-b hover:bg-gray-50">
                     <td class="px-4 py-2 font-mono">{row.trade_no}</td>
                     <td class="px-4 py-2">{row.updated_at}</td>
                     <td class="px-4 py-2 font-mono font-bold text-gray-900">{row.code}</td>
                   </tr>
                 ))}
               </tbody>
             </table>
           </div>
           <p class="mt-2 text-xs text-orange-600">如果用户支付成功但未收到码，请核对订单号并手动复制邀请码给用户。</p>
        </div>
      )}

      {message && (
        <div class={`mb-6 rounded-lg p-4 ${isError ? 'bg-red-50 text-red-800 border border-red-200' : 'bg-green-50 text-green-800 border border-green-200'}`}>
          {message}
        </div>
      )}

      <form method="POST" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 mb-8">
        <input type="hidden" name="action" value="import" />
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">管理密码</label>
          <input 
            type="password" 
            name="password" 
            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder="请输入管理员密码"
            required
          />
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">邀请码列表 (每行一个)</label>
          <textarea 
            name="codes" 
            rows="10" 
            class="w-full rounded-lg border border-gray-300 px-4 py-2 font-mono text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder="LINUXDO-CODE-1&#10;LINUXDO-CODE-2&#10;..."
          ></textarea>
        </div>

        <button 
          type="submit" 
          class="w-full rounded-full bg-blue-600 px-6 py-3 text-white font-semibold hover:bg-blue-700 transition"
        >
          导入邀请码
        </button>
      </form>

      <!-- Danger Zone -->
      <div class="bg-red-50 p-6 rounded-2xl border border-red-100">
          <h2 class="text-lg font-bold text-red-800 mb-6">数据维护</h2>
          
          <!-- 1. Cleanup Used -->
          <div class="mb-8 pb-8 border-b border-red-200">
            <h3 class="text-md font-bold text-red-700 mb-2">1. 清理已使用记录</h3>
            <p class="text-sm text-red-600 mb-4">删除所有已发放的邀请码记录。此操作不可恢复，请谨慎操作。</p>
            <form method="POST" onsubmit="return confirm('确定要删除所有已使用的邀请码吗？此操作不可撤销！');">
              <input type="hidden" name="action" value="cleanup" />
              <div class="flex gap-4">
                  <input 
                    type="password" 
                    name="password" 
                    class="flex-1 rounded-lg border border-red-200 px-4 py-2 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500 bg-white"
                    placeholder="请输入管理员密码"
                    required
                  />
                  <button 
                    type="submit" 
                    class="rounded-lg bg-red-600 px-6 py-2 text-white font-semibold hover:bg-red-700 transition whitespace-nowrap"
                  >
                    清理已使用
                  </button>
              </div>
            </form>
          </div>

          <!-- 2. Reset Reserved -->
          <div class="mb-8 pb-8 border-b border-red-200">
            <h3 class="text-md font-bold text-red-700 mb-2">2. 释放被锁定库存 (推荐)</h3>
            <p class="text-sm text-red-600 mb-4">将所有“支付中/锁定”状态的邀请码重置为“未使用”。<br/>如果用户未支付成功但库存被占，请使用此功能。</p>
            <form method="POST" onsubmit="return confirm('确定要释放所有被锁定的邀请码吗？');">
              <input type="hidden" name="action" value="reset_reserved" />
              <div class="flex gap-4">
                  <input 
                    type="password" 
                    name="password" 
                    class="flex-1 rounded-lg border border-red-200 px-4 py-2 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500 bg-white"
                    placeholder="请输入管理员密码"
                    required
                  />
                  <button 
                    type="submit" 
                    class="rounded-lg bg-orange-600 px-6 py-2 text-white font-semibold hover:bg-orange-700 transition whitespace-nowrap"
                  >
                    释放锁定
                  </button>
              </div>
            </form>
          </div>

          <!-- 3. Delete Reserved -->
          <div>
            <h3 class="text-md font-bold text-red-700 mb-2">3. 删除被锁定记录 (慎用)</h3>
            <p class="text-sm text-red-600 mb-4">彻底删除所有“支付中/锁定”状态的邀请码。<br/>注意：这会导致这些邀请码永久丢失！仅在确认这些码无效时使用。</p>
            <form method="POST" onsubmit="return confirm('警告：这将永久删除所有锁定的邀请码！确定要继续吗？');">
              <input type="hidden" name="action" value="delete_reserved" />
              <div class="flex gap-4">
                  <input 
                    type="password" 
                    name="password" 
                    class="flex-1 rounded-lg border border-red-200 px-4 py-2 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500 bg-white"
                    placeholder="请输入管理员密码"
                    required
                  />
                  <button 
                    type="submit" 
                    class="rounded-lg bg-red-800 px-6 py-2 text-white font-semibold hover:bg-red-900 transition whitespace-nowrap"
                  >
                    删除锁定
                  </button>
              </div>
            </form>
          </div>
      </div>
      
      <div class="mt-8 text-center">
          <a href="/" class="text-sm text-gray-500 hover:text-gray-900">返回首页</a>
      </div>
    </div>
  </body>
</html>
