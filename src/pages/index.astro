---
import "../styles/global.css";
import { navLinks, hero, features, steps, footer } from "../data/content.js";

// 缓存策略：首页主要为静态内容，边缘缓存 10 分钟以节省服务器资源
// 注意：如果后续添加了“实时库存显示”，需要缩短此缓存时间或改为客户端获取
const runtimeEnv = Astro.locals.runtime?.env || {};
const turnstileSiteKey = runtimeEnv.PUBLIC_TURNSTILE_SITE_KEY || import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || "";

Astro.response.headers.set('Cache-Control', 'public, max-age=600, s-maxage=600');
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LinuxDo 邀请码自助商店</title>
    <meta
      name="description"
      content="LinuxDo 社区邀请码自助商店，基于 Credit 积分支付，自动发货。"
    />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  </head>
  <body>
    <div class="mx-auto flex min-h-screen max-w-6xl flex-col px-6 pb-16 pt-8">
      <header class="flex items-center justify-between">
        <div class="text-lg font-semibold text-[color:var(--text-title)]">
          LinuxDo 商店
        </div>
        <nav class="flex gap-6 text-sm font-medium text-[color:var(--text-body)]">
          {navLinks.map((link) => (
            <a class="transition hover:text-[color:var(--brand-blue)]" href={link.href}>
              {link.label}
            </a>
          ))}
        </nav>
      </header>

      <main class="flex-1">
        <section class="mt-20 text-center">
          <h1 class="mx-auto max-w-3xl text-4xl font-semibold leading-tight text-[color:var(--text-title)] md:text-5xl">
            {hero.title}
          </h1>
          <p class="mx-auto mt-4 max-w-2xl text-base text-[color:var(--text-body)] md:text-lg">
            {hero.subtitle}
          </p>
          <div class="mt-8 flex flex-col items-center justify-center gap-4">
            {turnstileSiteKey && (
                <div class="cf-turnstile" data-sitekey={turnstileSiteKey}></div>
            )}
            <button
              id="buy-btn"
              class="rounded-full bg-[color:var(--brand-blue)] px-7 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-[color:var(--brand-blue-dark)] cursor-pointer"
            >
              {hero.cta.label}
            </button>
          </div>
        </section>

        <script>
          document.getElementById('buy-btn')?.addEventListener('click', async () => {
            const btn = document.getElementById('buy-btn');
            
            // Check Turnstile
            const turnstileInput = document.querySelector('[name="cf-turnstile-response"]');
            const turnstileWidget = document.querySelector('.cf-turnstile');
            let turnstileToken = '';
            
            if (turnstileWidget) {
                turnstileToken = turnstileInput?.value;
                if (!turnstileToken) {
                    alert('请先完成人机验证');
                    return;
                }
            }

            if (btn) {
              btn.innerText = '正在跳转...';
              btn.setAttribute('disabled', 'true');
              btn.classList.add('opacity-75');
            }

            try {
              const response = await fetch('/api/checkout', { 
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ turnstileToken })
              });
              const data = await response.json();
              
              if (data.error) {
                if (data.error.includes("Inventory shortage")) {
                    alert('抱歉，当前库存不足，请联系客服补货后再试。');
                    if (btn) {
                        btn.innerText = '库存不足';
                        // Keep disabled
                    }
                } else {
                    alert('Error: ' + data.error);
                    if (btn) {
                        btn.innerText = '重试';
                        btn.removeAttribute('disabled');
                        btn.classList.remove('opacity-75');
                    }
                }
                return;
              }

              // Save out_trade_no to sessionStorage
              sessionStorage.setItem('pending_order_no', data.params.out_trade_no);

              // Create form and submit
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = data.action;
              
              Object.keys(data.params).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data.params[key];
                form.appendChild(input);
              });
              
              document.body.appendChild(form);
              form.submit();
            } catch (err) {
              console.error(err);
              alert('发生错误，请稍后重试');
              if (btn) {
                btn.innerText = '重试';
                btn.removeAttribute('disabled');
                btn.classList.remove('opacity-75');
              }
            }
          });
        </script>

        <section class="mt-20">
          <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
            {features.map((feature) => (
              <div class="group rounded-2xl border border-[color:var(--border-soft)] bg-white p-6 shadow-sm transition hover:-translate-y-1 hover:shadow-md">
                <div class="mb-4 inline-flex h-10 w-10 items-center justify-center rounded-full bg-[color:var(--bg-soft)] text-[color:var(--brand-blue)]">
                  {feature.icon === "bolt" && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <path d="M13 2L3 14h8l-1 8 11-14h-8l0-6z" />
                    </svg>
                  )}
                  {feature.icon === "shield" && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <path d="M12 2l7 4v6c0 5-3.8 9-7 10-3.2-1-7-5-7-10V6l7-4z" />
                      <path d="M9.5 12.5l1.8 1.8 3.2-3.2" />
                    </svg>
                  )}
                  {feature.icon === "scale" && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <path d="M12 3v18" />
                      <path d="M5 7l-3 5h6l-3-5z" />
                      <path d="M22 12h-6l3-5 3 5z" />
                      <path d="M8 21h8" />
                      <path d="M5 7h14" />
                    </svg>
                  )}
                </div>
                <h3 class="text-lg font-semibold text-[color:var(--text-title)]">
                  {feature.title}
                </h3>
                <p class="mt-2 text-sm text-[color:var(--text-body)]">
                  {feature.description}
                </p>
              </div>
            ))}
          </div>
        </section>

        <section class="mt-16">
          <div class="rounded-3xl border border-[color:var(--border-soft)] bg-white p-8 shadow-sm">
            <h2 class="text-xl font-semibold text-[color:var(--text-title)]">购买流程</h2>
            <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3">
              {steps.map((step, index) => (
                <div class="rounded-2xl border border-[color:var(--border-soft)] bg-[color:var(--bg-soft)] p-4">
                  <div class="text-xs font-semibold uppercase tracking-widest text-[color:var(--brand-blue)]">
                    步骤 {index + 1}
                  </div>
                  <p class="mt-2 text-sm text-[color:var(--text-body)]">{step}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      </main>

      <footer class="mt-16 flex flex-col items-start justify-between gap-4 border-t border-[color:var(--border-soft)] pt-6 text-xs text-[color:var(--text-body)] md:flex-row md:items-center">
        <span>{footer.text}</span>
        <a class="transition hover:text-[color:var(--brand-blue)]" href={footer.privacy.href}>
          {footer.privacy.label}
        </a>
      </footer>
    </div>
  </body>
</html>
