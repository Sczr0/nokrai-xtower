---
import "../styles/global.css";

const { searchParams } = Astro.url;
// We will use client-side fetching to verify and get the code to keep this page static-friendly if needed,
// or we can do SSR directly here. Since we are already in 'server' mode, let's do SSR.

import crypto from 'node:crypto';

let verificationResult = { success: false, message: "正在验证..." };
let inviteCode = "";
let releaseReason = "";
let refundMessage = "";

try {
  let params = {};
  
  // 1. Try to get params from URL (GET)
  const searchParams = Astro.url.searchParams;
  if (searchParams.size > 0) {
      params = Object.fromEntries(searchParams);
  }
  
  // 2. Try to get params from Body (POST) - if GET failed or as supplement
   if (Astro.request.method === "POST") {
       try {
           const formData = await Astro.request.formData();
           const bodyParams = Object.fromEntries(formData);
           params = { ...params, ...bodyParams };
       } catch (e) {
           console.error("Failed to parse form data:", e);
       }
   }

   // 3. (Client-side) We need to handle the case where params are missing but we have localStorage
   // This part is tricky in SSR because we can't access localStorage here.
   // We will pass a flag to the client side to check localStorage.

   
   const runtimeKey = Astro.locals.runtime?.env?.LINUX_DO_CLIENT_SECRET;
   const runtimePid = Astro.locals.runtime?.env?.LINUX_DO_CLIENT_ID;
   const buildKey = import.meta.env.LINUX_DO_CLIENT_SECRET;
   const buildPid = import.meta.env.LINUX_DO_CLIENT_ID;
   const key = (runtimeKey != null ? String(runtimeKey) : (buildKey || "")).trim();
   const pid = (runtimePid != null ? String(runtimePid) : (buildPid || "")).trim();
 
   console.log(`[Callback] Method: ${Astro.request.method}, URL: ${Astro.request.url}`);
   console.log("[Callback] Params:", params); 

   const requestRefund = async ({ tradeNo, outTradeNo, money }) => {
      if (!pid || !key || !outTradeNo) {
         return "退款失败：缺少参数";
      }

      let resolvedTradeNo = tradeNo;
      let resolvedMoney = money;
      let orderStatus = null;

      try {
         if (!resolvedTradeNo || !resolvedMoney) {
            const queryUrl = `https://credit.linux.do/epay/api.php?act=order&pid=${pid}&key=${key}&out_trade_no=${outTradeNo}`;
            const response = await fetch(queryUrl);
            const data = await response.json();
            if (data.code === 1) {
               resolvedTradeNo = data.trade_no;
               resolvedMoney = data.money;
               orderStatus = data.status;
            } else {
               console.warn("Order query failed:", data);
               // Try to proceed if we have params even if query failed?
               // No, if query failed, we probably want to be careful.
               return `库存不足，且无法获取订单信息（${data.msg || "未知错误"}），请联系客服退款。`;
            }
         }

         if (orderStatus !== null && orderStatus !== 1) {
            return "库存不足，退款失败：订单未支付或处理中";
         }

         if (!resolvedTradeNo || !resolvedMoney) {
            return "库存不足，退款失败：订单信息不完整";
         }

         const doRefund = async (tradeNoToUse) => {
            const body = new URLSearchParams({
               pid,
               key,
               trade_no: String(tradeNoToUse || ""),
               money: String(resolvedMoney),
               out_trade_no: outTradeNo || ""
            });
            const response = await fetch("https://credit.linux.do/epay/api.php", {
               method: "POST",
               headers: { "Content-Type": "application/x-www-form-urlencoded" },
               body
            });
            const data = await response.json();
            return data;
         };

         let refundData = await doRefund(resolvedTradeNo);
         if (refundData?.code !== 1 && String(resolvedTradeNo || "") !== String(outTradeNo || "")) {
            const retry = await doRefund(outTradeNo);
            if (retry?.code === 1) refundData = retry;
         }

         if (refundData?.code === 1) return "库存不足，已发起退款";
         return `库存不足，退款失败：${refundData?.msg || "未知错误"}`;
      } catch (err) {
         console.error("Refund error:", err);
         return "库存不足，退款请求失败";
      }
   };
 
   const markRefundResult = (message) => {
      refundMessage = message;
      if (message.includes("已发起退款")) {
         verificationResult = { success: false, message: "支付成功但库存不足，已发起退款。" };
      } else {
         verificationResult = { success: false, message: message };
      }
   };

   if (params.sign) {
      // Existing signature verification logic...
      const sign = params.sign;
      const verifyParams = { ...params };
      delete verifyParams.sign;
      delete verifyParams.sign_type;
      
      const keys = Object.keys(verifyParams).filter(k => verifyParams[k] !== '' && verifyParams[k] !== undefined).sort();
      const paramStr = keys.map(k => `${k}=${verifyParams[k]}`).join('&');
      const signStr = paramStr + key;
      const calculatedSign = crypto.createHash('md5').update(signStr).digest('hex');
 
      if (calculatedSign === sign) {
          verificationResult = { success: true, message: "支付验证成功！" };
          
          const DB = Astro.locals.runtime?.env?.DB;
           if (DB) {
              try {
                  const targetTradeNo = (params.out_trade_no || "").trim();
                  // 1. Try to find the reserved code for this order
                  const { results } = await DB.prepare("SELECT * FROM invite_codes WHERE trade_no = ?").bind(targetTradeNo).all();
                  
                  if (results && results.length > 0) {
                      // Found reserved code
                      const code = results[0].code;
                      await DB.prepare("UPDATE invite_codes SET status = 'used', updated_at = CURRENT_TIMESTAMP WHERE id = ?").bind(results[0].id).run();
                      inviteCode = code;
                  } else {
                      // Fallback: If reservation expired or missing
                      // Debug: Check if there are ANY reserved codes
                      const recentReserved = await DB.prepare("SELECT trade_no, updated_at FROM invite_codes WHERE status = 'reserved' ORDER BY updated_at DESC LIMIT 1").first();
                      const debugInfo = recentReserved ? `Latest: ${recentReserved.trade_no}` : "No reserved codes found";

                      // Try to grab any unused code
                      const fallback = await DB.prepare("SELECT * FROM invite_codes WHERE status = 'unused' LIMIT 1").first();
                      if (fallback) {
                          await DB.prepare("UPDATE invite_codes SET status = 'used', updated_at = CURRENT_TIMESTAMP, trade_no = ? WHERE id = ?").bind(targetTradeNo, fallback.id).run();
                          inviteCode = fallback.code;
                      } else {
                          refundMessage = await requestRefund({
                             tradeNo: params.trade_no || "",
                             outTradeNo: targetTradeNo,
                             money: params.money || ""
                          });
                          markRefundResult(refundMessage);
                          await DB.prepare("UPDATE invite_codes SET status = 'unused', trade_no = NULL WHERE trade_no = ? AND status = 'reserved'").bind(targetTradeNo).run();
                          inviteCode = `${refundMessage} (Ref: ${targetTradeNo}, DB: ${debugInfo})`;
                      }
                  }
              } catch (dbErr) {
                  console.error("DB Error:", dbErr);
                  inviteCode = "系统错误，请联系客服: " + dbErr.message;
              }
           } else {
              inviteCode = "LINUXDO-2026-WELCOME-VIP"; 
           }
      } else {
          releaseReason = "签名验证失败";
          verificationResult = { success: false, message: "签名验证失败，请联系客服。" };
      }
   } else if (params.out_trade_no) {
       // Fallback: Query Order Status directly if no sign provided
       console.log("No signature found, querying order status for:", params.out_trade_no);
       try {
         const queryUrl = `https://credit.linux.do/epay/api.php?act=order&pid=${pid}&key=${key}&out_trade_no=${params.out_trade_no}`;
         const response = await fetch(queryUrl);
         const data = await response.json();
         console.log("Query Result:", data);
 
         if (data.code === 1 && data.status === 1) {
              verificationResult = { success: true, message: "支付验证成功！" };
              
              const DB = Astro.locals.runtime?.env?.DB;
              if (DB) {
                 try {
                     const targetTradeNo = (params.out_trade_no || "").trim();
                     const reserved = await DB.prepare("SELECT * FROM invite_codes WHERE trade_no = ?").bind(targetTradeNo).first();
                     if (reserved) {
                         await DB.prepare("UPDATE invite_codes SET status = 'used', updated_at = CURRENT_TIMESTAMP WHERE id = ?").bind(reserved.id).run();
                         inviteCode = reserved.code;
                     } else {
                         const fallback = await DB.prepare("SELECT * FROM invite_codes WHERE status = 'unused' LIMIT 1").first();
                         if (fallback) {
                             await DB.prepare("UPDATE invite_codes SET status = 'used', updated_at = CURRENT_TIMESTAMP, trade_no = ? WHERE id = ?").bind(targetTradeNo, fallback.id).run();
                             inviteCode = fallback.code;
                         } else {
                             refundMessage = await requestRefund({
                                tradeNo: data.trade_no || "",
                                outTradeNo: targetTradeNo,
                                money: data.money || ""
                             });
                             markRefundResult(refundMessage);
                             await DB.prepare("UPDATE invite_codes SET status = 'unused', trade_no = NULL WHERE trade_no = ? AND status = 'reserved'").bind(targetTradeNo).run();
                             inviteCode = refundMessage;
                         }
                     }
                 } catch (dbErr) {
                     console.error("DB Error:", dbErr);
                     inviteCode = "系统错误，请联系客服";
                 }
              } else {
                 inviteCode = "LINUXDO-2026-WELCOME-VIP";
              }
         } else {
              const messageText = data.msg || "";
              const isCompleted = messageText.includes("已完成");
              if (isCompleted) {
                  const DB = Astro.locals.runtime?.env?.DB;
                  if (DB) {
                      try {
                          const targetTradeNo = (params.out_trade_no || "").trim();
                          const reserved = await DB.prepare("SELECT * FROM invite_codes WHERE trade_no = ?").bind(targetTradeNo).first();
                          if (reserved) {
                              await DB.prepare("UPDATE invite_codes SET status = 'used', updated_at = CURRENT_TIMESTAMP WHERE id = ?").bind(reserved.id).run();
                              inviteCode = reserved.code;
                              verificationResult = { success: true, message: "支付验证成功！" };
                          } else {
                              refundMessage = await requestRefund({
                                  tradeNo: data.trade_no || "",
                                  outTradeNo: targetTradeNo,
                                  money: data.money || ""
                              });
                              markRefundResult(refundMessage);
                          }
                      } catch (dbErr) {
                          console.error("DB Error:", dbErr);
                          verificationResult = { success: false, message: "订单验证失败，请联系客服。" };
                      }
                  } else {
                      verificationResult = { success: false, message: "订单验证失败，请联系客服。" };
                  }
              } else {
                  releaseReason = data.code === 1 ? "订单未支付" : "订单不存在";
                  verificationResult = { success: false, message: "订单未支付或不存在。" };
              }
         }
       } catch (err) {
           console.error("Order query failed:", err);
           verificationResult = { success: false, message: "订单查询失败，请稍后刷新。" };
       }
   } else {
       // If no params, we might need client-side check
       // verificationResult = { success: false, message: "正在检测订单状态..." };
       // We'll let the initial state be a "Checking" state if no params are present, 
       // and let client-side script handle the localStorage check.
       if (Object.keys(params).length === 0) {
           verificationResult = { success: false, message: "CHECK_LOCAL_STORAGE" };
       } else {
           verificationResult = { success: false, message: "无效的请求参数: " + JSON.stringify(params) };
       }
   }
 
 if (!verificationResult.success && releaseReason) {
    const targetTradeNo = (params.out_trade_no || "").trim();
    const DB = Astro.locals.runtime?.env?.DB;
    if (DB && targetTradeNo) {
        await DB.prepare("UPDATE invite_codes SET status = 'unused', trade_no = NULL WHERE trade_no = ? AND status = 'reserved'").bind(targetTradeNo).run();
    }
 }
 } catch (e) {
     verificationResult = { success: false, message: "验证过程发生错误: " + e.message };
 }
 
 ---
 
 <!doctype html>
 <html lang="zh-CN">
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1" />
     <title>支付结果 - LinuxDo 邀请码商店</title>
   </head>
   <body>
     <div class="mx-auto flex min-h-screen max-w-xl flex-col items-center justify-center px-6 py-12 text-center">
       
       <div id="result-container">
           {verificationResult.message === "CHECK_LOCAL_STORAGE" ? (
             <div class="w-full rounded-3xl border border-blue-200 bg-blue-50 p-8 shadow-sm">
               <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 text-blue-600 animate-pulse">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-8 w-8">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                 </svg>
               </div>
               <h1 class="text-2xl font-bold text-blue-800">正在查询订单...</h1>
               <p class="mt-2 text-blue-700">请稍候，系统正在核实您的支付状态。</p>
             </div>
           ) : verificationResult.success ? (
             <div class="w-full rounded-3xl border border-green-200 bg-green-50 p-8 shadow-sm">
               <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100 text-green-600">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-8 w-8">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                 </svg>
               </div>
               <h1 class="text-2xl font-bold text-green-800">支付成功</h1>
               <p class="mt-2 text-green-700">感谢您的支持，您的邀请码如下：</p>
               
               <div class="mt-6 rounded-xl border border-dashed border-green-300 bg-white p-4">
                 <code class="text-xl font-mono font-bold tracking-wider text-green-900 select-all">
                   {inviteCode}
                 </code>
               </div>
               <p class="mt-2 text-xs text-green-600">请复制并尽快使用</p>
     
               <a href="/" class="mt-8 inline-block rounded-full bg-green-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-green-700">
                 返回首页
               </a>
             </div>
           ) : (
             <div class="w-full rounded-3xl border border-red-200 bg-red-50 p-8 shadow-sm">
               <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 text-red-600">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-8 w-8">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                 </svg>
               </div>
               <h1 class="text-2xl font-bold text-red-800">支付验证失败</h1>
               <p class="mt-2 text-red-700">{verificationResult.message}</p>
               
               <a href="/" class="mt-8 inline-block rounded-full bg-red-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-red-700">
                 返回首页
               </a>
             </div>
           )}
       </div>
 
     </div>

     <script>
        // Client-side check for pending order
        const checkSessionStorage = async () => {
          const messageElement = document.querySelector('h1');
          if (messageElement && messageElement.textContent === "正在查询订单...") {
              const orderNo = sessionStorage.getItem('pending_order_no');
              if (orderNo) {
                  console.log("Found pending order:", orderNo);
                  // Redirect to self with order number to trigger server-side check
                  window.location.href = `/callback?out_trade_no=${orderNo}`;
                  // Clear it to prevent loop if check fails, but maybe keep it until success?
                  // For now, let's keep it until verified or manual clear.
                  sessionStorage.removeItem('pending_order_no'); 
              } else {
                  // No order found locally either
                  const container = document.getElementById('result-container');
                  if (container) {
                      container.innerHTML = `
                      <div class="w-full rounded-3xl border border-red-200 bg-red-50 p-8 shadow-sm">
                        <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 text-red-600">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-8 w-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-800">未找到订单信息</h1>
                        <p class="mt-2 text-red-700">无法验证支付状态，请联系客服。</p>
                        <a href="/" class="mt-8 inline-block rounded-full bg-red-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-red-700">返回首页</a>
                      </div>`;
                  }
              }
          }
        };
        
        checkSessionStorage();
      </script>
   </body>
 </html>
